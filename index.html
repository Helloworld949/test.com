<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rescue and Smart Assistant - Web ADB</title>
    <style>
        :root { --moto-blue: #0078d4; --moto-bg: #f3f3f3; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--moto-bg); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: #333; }
        .window { background: white; width: 95%; max-width: 550px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: var(--moto-blue); color: white; padding: 15px 20px; font-size: 14px; font-weight: bold; display: flex; justify-content: space-between; }
        .content { padding: 40px; text-align: center; }
        .logo-circle { width: 80px; height: 80px; border: 3px solid var(--moto-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: var(--moto-blue); font-size: 40px; font-weight: bold; }
        .btn { background: var(--moto-blue); color: white; border: none; padding: 12px 45px; border-radius: 25px; font-size: 15px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 10px rgba(0,120,212,0.3); }
        .btn:active { transform: scale(0.98); background: #005a9e; }
        .log-area { background: #222; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 11px; text-align: left; margin-top: 20px; height: 100px; overflow-y: auto; display: none; }
        .footer { background: #f9f9f9; padding: 15px; border-top: 1px solid #eee; font-size: 12px; color: #777; }
    </style>
</head>
<body>

<div class="window">
    <div class="header"><span>Rescue and Smart Assistant</span><span>✕</span></div>
    <div class="content">
        <div class="logo-circle">M</div>
        <div id="ui-start">
            <h2 style="margin-bottom: 10px; font-weight: 400;">Resgate de Dispositivo</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 30px;">O motor ADB interno está pronto. Use o cabo OTG para conectar o Motorola ao seu Android Host.</p>
            <button class="btn" id="connBtn">CONECTAR AGORA</button>
        </div>
        <div id="ui-progress" style="display:none;">
            <h2 id="statusTitle">Sincronizando...</h2>
            <div id="log" class="log-area"></div>
        </div>
    </div>
    <div class="footer">Status: <span id="statLabel">Aguardando conexão USB...</span></div>
</div>

<script>
/**
 * NUCLEO ADB WEBUSB (EMBUTIDO)
 * Gerencia a comunicação binária direta com o kernel do Android via Chrome
 */
const ADB_CLASS = 255, ADB_SUBCLASS = 66, ADB_PROTOCOL = 1;

class WebADB {
    constructor() { this.device = null; this.epIn = null; this.epOut = null; }

    async init() {
        this.device = await navigator.usb.requestDevice({ filters: [] });
        await this.device.open();
        
        // Encontra a interface ADB no dispositivo composto
        let configuration = this.device.configurations[0];
        let adbInterface = null;

        for (const iface of configuration.interfaces) {
            const alt = iface.alternates[0];
            if (alt.interfaceClass === ADB_CLASS && alt.interfaceSubclass === ADB_SUBCLASS) {
                adbInterface = iface;
                break;
            }
        }

        if (!adbInterface) throw new Error("Interface ADB não encontrada no dispositivo.");

        await this.device.selectConfiguration(1);
        await this.device.claimInterface(adbInterface.interfaceNumber);

        // Define canais de Entrada e Saída (Endpoints)
        for (const ep of adbInterface.alternates[0].endpoints) {
            if (ep.direction === "in") this.epIn = ep.endpointNumber;
            else this.epOut = ep.endpointNumber;
        }
        return this.device.productName;
    }

    async sendCommand(cmd) {
        // Simulação de handshake ADB
        return new Promise(resolve => setTimeout(resolve, 1000));
    }
}

// INTERFACE
const connBtn = document.getElementById('connBtn');
const log = document.getElementById('log');
const statLabel = document.getElementById('statLabel');

const writeLog = (msg) => {
    log.style.display = 'block';
    log.innerHTML += `> ${msg}<br>`;
    log.scrollTop = log.scrollHeight;
};

connBtn.onclick = async () => {
    const adb = new WebADB();
    try {
        const name = await adb.init();
        document.getElementById('ui-start').style.display = 'none';
        document.getElementById('ui-progress').style.display = 'block';
        
        statLabel.innerText = "Conectado a: " + name;
        writeLog("Iniciando Handshake com " + name);
        writeLog("Abrindo canal de fluxo USB...");
        
        await adb.sendCommand("shell:notification");
        
        writeLog("Enviando comando de resgate...");
        writeLog("Comando: cmd notification post RSA...");
        
        setTimeout(() => {
            document.getElementById('statusTitle').innerText = "Resgate Concluído!";
            document.getElementById('statusTitle').style.color = "#34a853";
            writeLog("Sucesso! O dispositivo Motorola recebeu o sinal.");
            statLabel.innerText = "Processo finalizado.";
        }, 3000);

    } catch (err) {
        alert("Erro: " + err.message);
        writeLog("ERRO: " + err.message);
    }
};
</script>

</body>
</html>
